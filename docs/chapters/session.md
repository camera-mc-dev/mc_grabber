## The session manager

The session manager is a basic GUI interface for performing:

   1) session/trial/camera debayering
   2) session/trial/camera uploading to CAMERA RAID
   3) simplistic access to calibration tools

### Precursors

To use the session manager you will need to first tell it where to find raw recordings, and where to find/place debayered data, and the compiled tools that it needs.

To do this, create/edit a config file in your home directory: `~/.mc_dev.grabber.cfg`

The config file will probably already exist if you have used the grabber tool `sisoRec`, but some settings might not be present.

```

# what are the 2 locations where sessions are recorded to?
saveRoot0 = "/data/ssd0/recording/";
saveRoot1 = "/data/ssd1/recording/";

# where are processed / debayered sessions written to?
processedSessionsRoot = "/data2/fakeSessions/ssd0/processed/";

# where is the session manager daemon binary?
daemonBinary = "/opt/mc_bin/mc_grabber/sessionDaemon";

# where is the debayer tool binary?
debayerBinary = "/opt/mc_bin/mc_imgproc/debayer";

# where are the calibration binaries?
calibBinDir = "/opt/mc_bin/mc_core/";

```

### Using the tool

Start the tool from the command line, or from the desktop icon.

```bash
> /opt/mc_bin/mc_grabber/sessionManager
```

As it starts, it scans the two `saveRoots` and the `processedSessionsRoot` to find session/trial/camera information. It does not, currently, care about any meta data files that may be in the sessions.

<div style="text-align: center">
![Session manager GUI](imgs/manager/interface.png){style="width: 90%; margin: auto;"}
</div>

The top frame of the interface shows a list of sessions that have been found. Selecting a session will show the trials of that session. Selecting a trial will show the cameras of that trial. If you select a camera, you will see where the image data are, and whether it has found just raw data or also processed/debayered videos.

The second frame provides buttons to visualise a trial, or a single camera. The tool will _prefer_ to visualse debayered videos if they are available, otherwise it will show the raw data. Clicking on either button will run `renderSyncedSources` for either the selected camera, or the selected trial (as appropriate).

The third frame deals with the "daemon". A daemon is a background process that runs 'invisibly' on the computer. In this case, we have the `sessionDaemon` which runs through a list of jobs. The jobs are created by the `sessionManager` and include debayering of raw data to videos, as well as "mirroring" that data to a remote server. The buttons in this frame allow for starting and stopping the daemon, as well as clearing the list of jobs. The interface shows the status of the daemon, as well as the number of jobs that are on the list. Note that when you click to stop the demon, it will first finish its current task - in which case the status will turn orange until the demon is seen to actually stop.

The fourth frame provides tools for processing sessions/trials. There are two tabs. One tab provides tools for debayering sessions/trials/cameras. The second tab provides an interface for running our calibration tools.

The final fifth frame controls whether we want to mirror processed session data to a remote FTPS server, which, by default, is the CAMERA RAID.

#### Calibrating

Switch to the calibration tab in the processing frame of the interface and you will see _basic_ configuration options for calibration, as well as buttons to launch the various calibration tools. The calibration interface will greyed out if a calibration trial is not selected.

The calibration interface looks something like:

<div style="text-align: center">
![Calibration tab](imgs/manager/calib.png){style="width: 90%; margin: auto;"}
</div>

The check boxes allow turning on / off basic calibration settings, while the `vis frame` controls which frame will be used when running the point matcher. You will also be able to adjust the settings of the origin target.

If you use live calibration with the grabber, you should find that the settings are populated from the config file generated by the grabber.

You should be able to run through the typical calibration process using the buttons, as well as config settings - you'll only really end up in trouble if you didn't use the standard calibration grid. Advanced configuration can be done by manual editing of the calibration config file and command line use of the tools.

The one complicating factor is whether the calibration is being done in the raw data directory, or in the processed data directory.

If you used live grid detection with the grabber, then you will have grid detections and a calibration config in the raw source directories. In that case, the `raw dir` radio button will be checked. If you do calibration in the raw directory then you can copy that finished calibration to the processed directory using the `Raw -> RGB` button.

If you did not do live grid detection, then the GUI will work in the processed `RGB` directories for the trial.


#### Mirrorring

To upload processed / debayerd images to a remote ftps server such as the CAMERA RAID you can simply `check` the `Mirror to RAID` box.

Welll... almost.

Most servers will require that you log in to upload data, and the CAMERA RAID is no different. We actually don't do any of the heavy lifting of copying the data, and defer that process to the `lftp` program - a very nifty ftp client.

You will need to "bookmark" your login credentials for the server so that the sessionDaemon can freely make use of lftp for all copying operations without pestering you for a login password all the time.

To do this, specify the RAID host (servername), your username for the RAID, then click the `bookmark raid login` button. This will show a konsole window prompting you for a password - you should enter your server login password here and hit return. The window should then close.

If you have sensitive login credentials then you might want to make sure that the bookmarked credentials are removed once you have completed processing your session. Simply click the `Delete login bookmark` button to do that - making sure the RAID user and RAID host are correct.

When the `Mirror to RAID` box is active, any time you create a debayer job, you also create a `mirror` job to take the processed data and transfer it to the RAID. The advantage of using the `mirror` command is that we don't upload data that already exists unless the local system has _newer_ data.

Another advantage of letting `lftp` handle all the copying for us is that it has the ability to run multiple copy jobs in parallel - that can make a big difference when copying many small files. 

If you previously processed a session / trial / camera _without_ having `Mirror to RAID` enabled, simply re-do the debayer job. (The debayer tool will skip videos that already exist and thus rapidly skip through the jobs, and then the mirroring job will start ).

#### Debayering

Debayering is the process of taking the raw recordings and turning them into colour images, and also compressing them to easier to use / store video files.

To debayer a session, or just a trial, or just a camera, select the appropriate session / trial / camera. Then click on the `Queue Session` or `Queue Trial` or `Queue camera` buttons. You will see that job added to the jobs list. If you have mirroring enabled you will also see a mirror job added.

Once you have a suitable set of jobs, click the `Launch jobs` button. This will convert the jobs list into a set of job files for the `sessionDaemon` and you should see the number of jobs in the demon status frame increase.

If the daemon is not already running, make sure you start it so that jobs get processed.

Once the daemon is running you can quit the session manager, and even log out of the computer, knowing that the daemon will carry on working on your behalf.

If you need to do more grabbing and want to stop the daemon to free up disk resources, start up the session manager and click the `Stop Daemon` button. The daemon will finish its current job and will then quit. (The `Stop Daemon` button basically creates a special job on the daemon's job list that tells it to quit.).

If you run create jobs to debayer a session/trial/camera and there are already video outputs, the debayer tool will skip those files.

